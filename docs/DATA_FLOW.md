# ğŸ“Š Kahani Data Flow Diagrams (DFD)

## DFD Level 0: Context Diagram

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Storyteller    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚             â”‚  (User)         â”‚           â”‚
          â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
          â”‚                                            â”‚
    [Stories]                                    [Auth Token]
    [PDFs]                                       [Contributions]
          â”‚                                            â”‚
          â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
          â”‚             â”‚                 â”‚           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  KAHANI SYSTEM  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                 â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚            â”‚            â”‚
              [Context]      [Lore]      [Blocks]
                    â”‚            â”‚            â”‚
                    â–¼            â–¼            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Vector   â”‚  â”‚   LLM    â”‚  â”‚Blockchainâ”‚
            â”‚ Database â”‚  â”‚  (Groq)  â”‚  â”‚ Network  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**External Entities:**
- **Storyteller**: End user creating collaborative narratives
- **Vector Database**: Milvus for semantic search
- **LLM Service**: Groq Cloud for story generation
- **Blockchain Network**: Decentralized ledger (future)

---

## DFD Level 1: Main System Processes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        KAHANI SYSTEM                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚  User   â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                        â”‚
â”‚       â”‚                                                             â”‚
â”‚       â”‚ [1] Story Prompt                                            â”‚
â”‚       â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚  â”‚   P1: Story    â”‚â”€â”€[Context Request]â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   Suggestion   â”‚â—€â”€[Relevant Stories]â”€â”€â”‚ D1:      â”‚              â”‚
â”‚  â”‚   Generator    â”‚                      â”‚ Milvus   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚ Vectors  â”‚              â”‚
â”‚           â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚           â”‚ [2] AI Suggestion                                       â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚  â”‚   P2: Story    â”‚                                                 â”‚
â”‚  â”‚   Editor &     â”‚                                                 â”‚
â”‚  â”‚   Verifier     â”‚                                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚           â”‚                                                         â”‚
â”‚           â”‚ [3] Verified Line                                       â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[Store]â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚   P3: Story    â”‚            â”‚ D2:      â”‚                        â”‚
â”‚  â”‚   Persistence  â”‚â—€â”€[Retrieve]â”‚ SQLite   â”‚                        â”‚
â”‚  â”‚   Manager      â”‚            â”‚ Database â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚           â”‚                                                         â”‚
â”‚           â”‚ [4] Embedding                                           â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[Vector]â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   P4: Vector   â”‚             â”‚ D1:      â”‚                       â”‚
â”‚  â”‚   Embedding    â”‚             â”‚ Milvus   â”‚                       â”‚
â”‚  â”‚   Storage      â”‚             â”‚ Vectors  â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚           â”‚                                                         â”‚
â”‚           â”‚ [Background Task]                                       â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[Extract]â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚   P5: Lore     â”‚              â”‚ D3:      â”‚                      â”‚
â”‚  â”‚   Extractor    â”‚â—€â”€[Query]â”€â”€â”€â”€â”€â”‚ Lore DB  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚           â”‚                                                         â”‚
â”‚           â”‚ [5] Request Canonical                                   â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[Polish]â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚   P6: Story    â”‚              â”‚ D4:      â”‚                      â”‚
â”‚  â”‚   Canonicalizerâ”‚              â”‚ Canonicalâ”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ Stories  â”‚                      â”‚
â”‚           â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚           â”‚ [6] NFT Mint (future)                                   â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[Transaction]â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   P7: NFT      â”‚                 â”‚ D5:        â”‚                 â”‚
â”‚  â”‚   Minter       â”‚â—€â”€â”€[Confirm]â”€â”€â”€â”€â”€â”‚ Blockchain â”‚                 â”‚
â”‚  â”‚  (Work in      â”‚                 â”‚ Ledger     â”‚                 â”‚
â”‚  â”‚   Progress)    â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Data Stores:**
- **D1**: Milvus Vectors (semantic search index)
- **D2**: SQLite Database (story lines, metadata)
- **D3**: Lore DB (extracted entities)
- **D4**: Canonical Stories (polished narratives)
- **D5**: Blockchain Ledger (immutable record - future)

---

## DFD Level 2: Story Suggestion Process (P1)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              P1: STORY SUGGESTION GENERATOR                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  [Input: User Prompt]                                        â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚  â”‚ P1.1: Prompt   â”‚                                          â”‚
â”‚  â”‚ Sanitization   â”‚                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚           â”‚ [Cleaned Prompt]                                 â”‚
â”‚           â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[Query Vector]â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ P1.2: Generate â”‚                   â”‚ D1:      â”‚          â”‚
â”‚  â”‚ Query Embeddingâ”‚                   â”‚ Sentence â”‚          â”‚
â”‚  â”‚ (384-dim)      â”‚                   â”‚Transform â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚           â”‚                                                  â”‚
â”‚           â”‚ [Embedding Vector]                               â”‚
â”‚           â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[Search]â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ P1.3: Semantic â”‚                   â”‚ D1:      â”‚          â”‚
â”‚  â”‚ Search (Milvus)â”‚â—€â”€[Top-K Results]â”€â”€â”‚ Milvus   â”‚          â”‚
â”‚  â”‚ top_k=10       â”‚                   â”‚ Vectors  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚           â”‚                                                  â”‚
â”‚           â”‚ [Context: Past Stories]                          â”‚
â”‚           â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚  â”‚ P1.4: Assemble â”‚                                          â”‚
â”‚  â”‚ LLM Prompt     â”‚                                          â”‚
â”‚  â”‚ (Context +     â”‚                                          â”‚
â”‚  â”‚  User Prompt)  â”‚                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚           â”‚                                                  â”‚
â”‚           â”‚ [Full Prompt]                                    â”‚
â”‚           â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[API Call]â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ P1.5: LLM      â”‚                   â”‚ Groq     â”‚          â”‚
â”‚  â”‚ Generation     â”‚â—€â”€[Response]â”€â”€â”€â”€â”€â”€â”€â”‚ Cloud    â”‚          â”‚
â”‚  â”‚ (llama-3.1)    â”‚                   â”‚ (LLM-1)  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚           â”‚                                                  â”‚
â”‚           â”‚ [Generated Story Line]                           â”‚
â”‚           â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚  â”‚ P1.6: Format   â”‚                                          â”‚
â”‚  â”‚ Response with  â”‚                                          â”‚
â”‚  â”‚ Context Metadata                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  [Output: {suggestion, context_used, context_count}]        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## DFD Level 2: Story Verification & Persistence (P2 + P3)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           P2: STORY EDITOR & VERIFIER                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  [Input: AI Suggestion + User Edit]                          â”‚
â”‚         â”‚                                                     â”‚
â”‚         â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P2.1: Compare  â”‚                                           â”‚
â”‚  â”‚ Original vs    â”‚                                           â”‚
â”‚  â”‚ Edited Version â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚ [Delta: user_edited flag]                         â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P2.2: User     â”‚â—€â”€[JWT Token]â”€â”€[Supabase Auth]            â”‚
â”‚  â”‚ Authentication â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚ [user_id]                                         â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P2.3: Create   â”‚                                           â”‚
â”‚  â”‚ Verified Story â”‚                                           â”‚
â”‚  â”‚ Line Object    â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚ [StoryLine{verified=true}]                        â”‚
â”‚           â–¼                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           P3: STORY PERSISTENCE MANAGER                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[INSERT]â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ P3.1: Store in â”‚                   â”‚ D2:      â”‚           â”‚
â”‚  â”‚ SQLite         â”‚                   â”‚ SQLite   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚ story_   â”‚           â”‚
â”‚           â”‚                           â”‚ lines    â”‚           â”‚
â”‚           â”‚ [Assigned ID]             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P3.2: Generate â”‚                                           â”‚
â”‚  â”‚ Embedding      â”‚                                           â”‚
â”‚  â”‚ (384-dim)      â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚ [Vector]                                          â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[INSERT]â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ P3.3: Store    â”‚                   â”‚ D1:      â”‚           â”‚
â”‚  â”‚ Vector in      â”‚                   â”‚ Milvus   â”‚           â”‚
â”‚  â”‚ Milvus         â”‚                   â”‚ Vectors  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [embedding_id]                                    â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[UPDATE]â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ P3.4: Link     â”‚                   â”‚ D2:      â”‚           â”‚
â”‚  â”‚ Embedding ID   â”‚                   â”‚ SQLite   â”‚           â”‚
â”‚  â”‚ to Story Line  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â–¼                                                   â”‚
â”‚  [Output: Stored Story Line with embedding_id]               â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## DFD Level 2: Lore Extraction (P5)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                P5: LORE EXTRACTOR                             â”‚
â”‚                (Background Task: Every 30 min)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  [Trigger: Scheduled Task / Manual Request]                  â”‚
â”‚         â”‚                                                     â”‚
â”‚         â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[SELECT verified]â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ P5.1: Fetch    â”‚                      â”‚ D2:      â”‚        â”‚
â”‚  â”‚ Recent Verifiedâ”‚â—€â”€[Story Lines]â”€â”€â”€â”€â”€â”€â”€â”‚ SQLite   â”‚        â”‚
â”‚  â”‚ Lines          â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Array of story texts]                            â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P5.2: Aggregateâ”‚                                           â”‚
â”‚  â”‚ Text for       â”‚                                           â”‚
â”‚  â”‚ Analysis       â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Concatenated story text]                         â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[LLM Call]â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ P5.3: LLM      â”‚                      â”‚ Groq     â”‚        â”‚
â”‚  â”‚ Entity         â”‚â—€â”€[Entities JSON]â”€â”€â”€â”€â”€â”‚ Cloud    â”‚        â”‚
â”‚  â”‚ Extraction     â”‚                      â”‚ (LLM-1)  â”‚        â”‚
â”‚  â”‚ Prompt:        â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”‚ "Extract chars,â”‚                                           â”‚
â”‚  â”‚  locations,    â”‚                                           â”‚
â”‚  â”‚  events, items"â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Structured Lore JSON]                            â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P5.4: Parse &  â”‚                                           â”‚
â”‚  â”‚ Validate JSON  â”‚                                           â”‚
â”‚  â”‚ (characters,   â”‚                                           â”‚
â”‚  â”‚  locations,    â”‚                                           â”‚
â”‚  â”‚  events, items)â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Validated Entities]                              â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P5.5: Create   â”‚                                           â”‚
â”‚  â”‚ Embeddings for â”‚                                           â”‚
â”‚  â”‚ Each Entity    â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Entity + Vector pairs]                           â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[INSERT]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ P5.6: Store    â”‚                     â”‚ D3:      â”‚         â”‚
â”‚  â”‚ Lore Entries   â”‚                     â”‚ Lore DB  â”‚         â”‚
â”‚  â”‚ in SQLite      â”‚                     â”‚ (SQLite) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [lore_entry_ids]                                  â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[INSERT Vectors]â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ P5.7: Store    â”‚                     â”‚ D1:      â”‚         â”‚
â”‚  â”‚ Lore Vectors   â”‚                     â”‚ Milvus   â”‚         â”‚
â”‚  â”‚ in Milvus      â”‚                     â”‚ lore_    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚ vectors  â”‚         â”‚
â”‚           â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚           â–¼                                                   â”‚
â”‚  [Output: Enriched Knowledge Base]                           â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## DFD Level 2: Story Canonicalization (P6)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              P6: STORY CANONICALIZER                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  [Input: line_ids[] + title]                                 â”‚
â”‚         â”‚                                                     â”‚
â”‚         â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[SELECT WHERE id IN]â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ P6.1: Fetch    â”‚                        â”‚ D2:      â”‚     â”‚
â”‚  â”‚ Story Lines    â”‚â—€â”€[Story Line objects]â”€â”€â”‚ SQLite   â”‚     â”‚
â”‚  â”‚ by IDs         â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Array of verified lines]                         â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P6.2: Sort by  â”‚                                           â”‚
â”‚  â”‚ Timestamp      â”‚                                           â”‚
â”‚  â”‚ (Chronological)â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Ordered story fragments]                         â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P6.3: Assemble â”‚                                           â”‚
â”‚  â”‚ Context for    â”‚                                           â”‚
â”‚  â”‚ LLM-2          â”‚                                           â”‚
â”‚  â”‚ Prompt:        â”‚                                           â”‚
â”‚  â”‚ "Polish into   â”‚                                           â”‚
â”‚  â”‚  coherent      â”‚                                           â”‚
â”‚  â”‚  narrative"    â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Canonicalization Prompt]                         â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[API Call]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ P6.4: LLM-2    â”‚                       â”‚ Groq     â”‚       â”‚
â”‚  â”‚ Generation     â”‚â—€â”€[Polished Text]â”€â”€â”€â”€â”€â”€â”‚ Cloud    â”‚       â”‚
â”‚  â”‚ (llama-3.1)    â”‚                       â”‚ (LLM-2)  â”‚       â”‚
â”‚  â”‚ temp=0.5       â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Canonical story text]                            â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P6.5: Calculateâ”‚                                           â”‚
â”‚  â”‚ Metadata       â”‚                                           â”‚
â”‚  â”‚ (word count,   â”‚                                           â”‚
â”‚  â”‚  line count)   â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Metadata object]                                 â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[INSERT]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ P6.6: Store    â”‚                         â”‚ D4:      â”‚     â”‚
â”‚  â”‚ Canonical Storyâ”‚                         â”‚ Canonicalâ”‚     â”‚
â”‚  â”‚ in Database    â”‚                         â”‚ Stories  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [canonical_story_id]                              â”‚
â”‚           â–¼                                                   â”‚
â”‚  [Output: {id, title, full_text, original_lines_count}]      â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## DFD Level 2: NFT Minting (P7) - Future Implementation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              P7: NFT MINTER (Work in Progress)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  [Input: canonical_story_id]                                 â”‚
â”‚         â”‚                                                     â”‚
â”‚         â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[SELECT]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ P7.1: Fetch    â”‚                         â”‚ D4:      â”‚     â”‚
â”‚  â”‚ Canonical Storyâ”‚â—€â”€[Story + line_ids]â”€â”€â”€â”€â”€â”‚ Canonicalâ”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚ Stories  â”‚     â”‚
â”‚           â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Story object]                                    â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[SELECT contributions]â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ P7.2: Fetch    â”‚                          â”‚ D2:      â”‚    â”‚
â”‚  â”‚ All            â”‚â—€â”€[Contribution array]â”€â”€â”€â”€â”‚ SQLite   â”‚    â”‚
â”‚  â”‚ Contributions  â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [user_id â†’ contribution_count mapping]            â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P7.3: Calculateâ”‚                                           â”‚
â”‚  â”‚ Co-Authorship  â”‚                                           â”‚
â”‚  â”‚ - Main Author  â”‚                                           â”‚
â”‚  â”‚ - Co-Authors   â”‚                                           â”‚
â”‚  â”‚ - Ownership %  â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Author metadata]                                 â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P7.4: Generate â”‚                                           â”‚
â”‚  â”‚ NFT Image      â”‚                                           â”‚
â”‚  â”‚ (Story title,  â”‚                                           â”‚
â”‚  â”‚  author graph) â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Image PNG binary]                                â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[Upload]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ P7.5: Upload   â”‚                          â”‚ IPFS     â”‚    â”‚
â”‚  â”‚ Image to IPFS  â”‚â—€â”€[Image CID]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Network  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [QmXXX... image CID]                              â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P7.6: Create   â”‚                                           â”‚
â”‚  â”‚ NFT Metadata   â”‚                                           â”‚
â”‚  â”‚ JSON           â”‚                                           â”‚
â”‚  â”‚ {title, image, â”‚                                           â”‚
â”‚  â”‚  authors[...]} â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Metadata JSON]                                   â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[Upload]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ P7.7: Upload   â”‚                          â”‚ IPFS     â”‚    â”‚
â”‚  â”‚ Metadata to    â”‚â—€â”€[Metadata CID]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Network  â”‚    â”‚
â”‚  â”‚ IPFS           â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [QmYYY... metadata CID]                           â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ P7.8: Create   â”‚                                           â”‚
â”‚  â”‚ mint_nft       â”‚                                           â”‚
â”‚  â”‚ Transaction    â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                   â”‚
â”‚           â”‚ [Signed Transaction]                              â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€[Broadcast]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ P7.9: Submit toâ”‚                          â”‚ D5:      â”‚    â”‚
â”‚  â”‚ Validator      â”‚                          â”‚ Blockchain    â”‚
â”‚  â”‚ Network (PBFT) â”‚â—€â”€[Block Confirmation]â”€â”€â”€â”€â”‚ Network  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚ (Validators)  â”‚
â”‚           â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚ [NFT Token ID]                                    â”‚
â”‚           â–¼                                                   â”‚
â”‚  [Output: {token_id, image_cid, metadata_cid, authors[]}]    â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Dictionary

### Data Flows

| Flow ID | Name | Description | Format |
|---------|------|-------------|--------|
| F1 | Story Prompt | User's creative writing prompt | String (UTF-8, max 500 chars) |
| F2 | AI Suggestion | LLM-generated story continuation | String (JSON: {suggestion, context_used, context_count}) |
| F3 | Verified Line | User-approved story sentence | Object: {id, user_id, line_text, llm_proposed, user_edited, verified, timestamp} |
| F4 | Embedding | 384-dimensional vector representation | float32[384] |
| F5 | Context Request | Semantic search query | Object: {query_text, top_k, filters} |
| F6 | Relevant Stories | Retrieved context from vector DB | Array of {line_id, text, similarity_score} |
| F7 | Lore Entities | Extracted world-building elements | Object: {characters[], locations[], events[], items[]} |
| F8 | Canonical Story | Polished narrative output | Object: {id, title, full_text, original_lines_count, created_at} |
| F9 | NFT Transaction | Blockchain mint request | Object: {story_id, image_cid, metadata_cid, authors[], signatures[]} |
| F10 | Block Confirmation | Consensus approval | Object: {block_index, tx_id, validator_signatures[]} |

### Data Stores

| Store ID | Name | Type | Content | Persistence |
|----------|------|------|---------|-------------|
| D1 | Milvus Vectors | Vector DB | 384-dim embeddings + metadata | RAM + Disk (index) |
| D2 | SQLite Database | Relational DB | story_lines, metadata | Disk (kahani.db) |
| D3 | Lore DB | Relational DB | lore_entries (characters, locations, events, items) | Disk (kahani.db) |
| D4 | Canonical Stories | Relational DB | canonical_stories table | Disk (kahani.db) |
| D5 | Blockchain Ledger | BadgerDB (KV) | Immutable blocks + state | Disk (blockchain/) |
| D6 | IPFS Network | Content-Addressed | Story text, NFT images/metadata | Distributed |

### Processes

| Process ID | Name | Inputs | Outputs | Trigger |
|------------|------|--------|---------|---------|
| P1 | Story Suggestion Generator | User prompt, Vector DB context | AI suggestion + context metadata | User request |
| P2 | Story Editor & Verifier | AI suggestion, User edit, JWT token | Verified story line object | User action |
| P3 | Story Persistence Manager | Verified story line | Stored line + embedding_id | P2 completion |
| P4 | Vector Embedding Storage | Story text | 384-dim vector in Milvus | P3 completion |
| P5 | Lore Extractor | Recent verified lines | Extracted entities (characters, etc.) | Scheduled (30 min) or manual |
| P6 | Story Canonicalizer | line_ids[], title | Polished canonical story | User request |
| P7 | NFT Minter (future) | canonical_story_id | NFT token_id + blockchain entry | User request |

---

## Sequence Diagrams

### Sequence 1: User Creates Story Line

```
User          Frontend       API Proxy      FastAPI       Milvus      Groq LLM
 â”‚                â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚â”€[1] Enterâ”€â”€â”€â”€â–¶â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚   prompt      â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚â”€[2] POSTâ”€â”€â”€â”€â–¶â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚   suggest    â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚â”€[3] Forwardâ–¶â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚â”€[4] Queryâ”€â–¶â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚   context  â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚â—€[5] Top-Kâ”€â”€â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚   results  â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚â”€[6] Generateâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
 â”‚               â”‚              â”‚             â”‚   w/contextâ”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚â—€[7] Storyâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚               â”‚              â”‚             â”‚   suggestion           â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚â—€[8] Returnâ”€â”€â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚   JSON      â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚â—€[9] Responseâ”€â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚â—€[10] Displayâ”€â”€â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚    suggestion â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚â”€[11] Edit &â”€â”€â–¶â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚    Sign       â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚â”€[12] POSTâ”€â”€â”€â–¶â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚   edit       â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚â”€[13] Storeâ”€â–¶â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚   in SQLite â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚â”€[14] Embedâ–¶â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚   & store  â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚â—€[15] OKâ”€â”€â”€â”€â”€â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚â—€[16] Successâ”€â”‚             â”‚            â”‚            â”‚
 â”‚               â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚â—€[17] Updatedâ”€â”€â”‚              â”‚             â”‚            â”‚            â”‚
 â”‚    story list â”‚              â”‚             â”‚            â”‚            â”‚
```

### Sequence 2: Background Lore Extraction

```
Scheduler      FastAPI      SQLite DB    Groq LLM    Milvus
    â”‚              â”‚             â”‚            â”‚          â”‚
[30 min]           â”‚             â”‚            â”‚          â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚
    â”‚â”€[1] Triggerâ”€â–¶â”‚             â”‚            â”‚          â”‚
    â”‚   lore task  â”‚             â”‚            â”‚          â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚
    â”‚              â”‚â”€[2] SELECTâ”€â–¶â”‚            â”‚          â”‚
    â”‚              â”‚   verified  â”‚            â”‚          â”‚
    â”‚              â”‚   lines     â”‚            â”‚          â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚
    â”‚              â”‚â—€[3] Storyâ”€â”€â”€â”‚            â”‚          â”‚
    â”‚              â”‚   texts     â”‚            â”‚          â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚
    â”‚              â”‚â”€[4] Extract entitiesâ”€â”€â”€â”€â–¶â”‚          â”‚
    â”‚              â”‚   prompt    â”‚            â”‚          â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚
    â”‚              â”‚â—€[5] Entitiesâ”‚            â”‚          â”‚
    â”‚              â”‚   JSON      â”‚            â”‚          â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚
    â”‚              â”‚â”€[6] Parse & â”‚            â”‚          â”‚
    â”‚              â”‚   validate  â”‚            â”‚          â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚
    â”‚              â”‚â”€[7] INSERTâ”€â–¶â”‚            â”‚          â”‚
    â”‚              â”‚   lore_     â”‚            â”‚          â”‚
    â”‚              â”‚   entries   â”‚            â”‚          â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚
    â”‚              â”‚â”€[8] Embedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚              â”‚   entities  â”‚            â”‚          â”‚
    â”‚              â”‚             â”‚            â”‚          â”‚
    â”‚â—€[9] Completeâ”€â”‚             â”‚            â”‚          â”‚
```

### Sequence 3: NFT Minting (Future)

```
User      Frontend    API Proxy   FastAPI   Blockchain   IPFS
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚â”€[1] Clickâ”€â–¶â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚  "Mint NFT"â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚â”€[2] POSTâ”€â–¶â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚  canonicalize        â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚â”€[3] â”€â”€â”€â”€â–¶â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚  Polish  â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚â—€[4] Storyâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚          â”‚          â”‚
 â”‚            â”‚  canonicalâ”‚          â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚â—€[5] Showâ”€â”€â”€â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚  canonical â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚â”€[6] POSTâ”€â”€â–¶â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚  mint_nft  â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[7] Aggregateâ”€â”€â”€â”€â–¶â”‚          â”‚
 â”‚            â”‚           â”‚  contributions      â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚         [8] Generateâ”‚          â”‚
 â”‚            â”‚           â”‚          NFT image  â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚â”€[9] Upload imageâ”€â”€â”€â–¶â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚â—€[10] CIDâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚â”€[11] Upload metadataâ–¶â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚â—€[12] CIDâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚â”€[13] mint_nft txâ”€â”€â”€â–¶â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚â”€[PBFT]   â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚ consensusâ”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚â—€[14] Block committedâ”‚
 â”‚            â”‚           â”‚          â”‚   token_id          â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚            â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[15] NFT mintedâ”€â”€â”€â”‚          â”‚
 â”‚            â”‚           â”‚  {token_id, CIDs}   â”‚          â”‚
 â”‚            â”‚           â”‚          â”‚          â”‚          â”‚
 â”‚â—€[16] Successâ”€          â”‚          â”‚          â”‚          â”‚
 â”‚  + token_idâ”‚           â”‚          â”‚          â”‚          â”‚
```

---

## State Transition Diagrams

### Story Line States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DRAFT   â”‚  [User typing in UI]
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ [User clicks "Summon Suggestion"]
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SUGGESTED   â”‚  [AI returned proposal]
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ [User edits or accepts]
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   EDITED     â”‚  [Local state in browser]
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ [User clicks "Add to Story"]
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SUBMITTED   â”‚  [POST to backend]
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ [Backend validates & stores]
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   VERIFIED   â”‚  [Persisted in SQLite + Milvus]
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ [Background task or manual request]
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IN_CANONICAL â”‚  [Part of polished story]
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ [NFT minting (future)]
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MINTED_NFT  â”‚  [Immutable on blockchain]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Blockchain Transaction States (Future)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PENDING  â”‚  [Created, not broadcast]
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ [Broadcast to validators]
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PRE_PREPAREâ”‚  [Leader proposes block]
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ [Validators receive]
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PREPARE  â”‚  [Validators send prepare msg]
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ [2f+1 prepare messages received]
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COMMIT   â”‚  [Validators send commit msg]
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ [2f+1 commit messages received]
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FINALIZED â”‚  [Block added to chain]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Access Patterns

### Read Operations

| Operation | Process | Data Store | Query Pattern | Frequency |
|-----------|---------|------------|---------------|-----------|
| Get story suggestions | P1 | D1 (Milvus) | Vector similarity search | On user prompt |
| Fetch story lines | Frontend | D2 (SQLite) | SELECT * FROM story_lines WHERE verified=true | Page load |
| Retrieve lore | P5, Frontend | D3 (Lore DB) | SELECT * FROM lore_entries WHERE entity_type=? | Background + UI |
| Get canonical story | P6, Frontend | D4 (Canonical) | SELECT * FROM canonical_stories WHERE id=? | User request |
| Fetch NFT metadata | Frontend | D5 (Blockchain) | Get NFT by token_id | NFT gallery view |
| Context retrieval | P1 | D1 (Milvus) | topK(embedding, k=10) | Every suggestion |

### Write Operations

| Operation | Process | Data Store | Write Pattern | Frequency |
|-----------|---------|------------|---------------|-----------|
| Store story line | P3 | D2 (SQLite) | INSERT INTO story_lines | Per contribution |
| Save embedding | P4 | D1 (Milvus) | INSERT vector + metadata | Per contribution |
| Store lore entities | P5 | D3 (Lore DB) | INSERT INTO lore_entries | Every 30 min (batch) |
| Save canonical story | P6 | D4 (Canonical) | INSERT INTO canonical_stories | On finalization |
| Mint NFT transaction | P7 | D5 (Blockchain) | Append block to chain | On NFT mint |
| Upload to IPFS | P7 | D6 (IPFS) | IPFS.add(content) | On NFT creation |

---

## Performance Metrics

### Expected Latencies

| Operation | Target Latency | Bottleneck |
|-----------|----------------|------------|
| Story suggestion | < 3s | Groq LLM API |
| Vector search | < 100ms | Milvus query |
| Store story line | < 200ms | SQLite write + embedding gen |
| Lore extraction | ~10-30s | LLM entity extraction (batch) |
| Canonicalization | ~5-15s | LLM-2 polish |
| NFT minting | ~3-5s | PBFT consensus (future) |

### Throughput Estimates

| Metric | Current (AI Only) | Future (With Blockchain) |
|--------|-------------------|--------------------------|
| Concurrent users | ~100 | ~1000 (with observers) |
| Stories/hour | ~500 | ~500 (write limited by validators) |
| Reads/second | ~50 | ~500 (distributed observers) |
| NFTs minted/hour | N/A | ~200 (PBFT throughput) |

---

This DFD documentation provides complete visibility into data transformations across the Kahani system, from user input through AI processing to future blockchain persistence.
